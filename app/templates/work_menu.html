{% extends "base.html" %}

{% block title %}–†–∞–±–æ—á–µ–µ –º–µ–Ω—é{% endblock %}

{% block content %}
<h1>üè≠ –†–∞–±–æ—á–µ–µ –º–µ–Ω—é</h1>

<div class="shift-info">
    <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ</h3>
    <p><strong>–î–∞—Ç–∞:</strong> {{ shift.date }}</p>
    <p><strong>–°–º–µ–Ω–∞:</strong> {{ shift.shift_number }} ({{ shift.start_time }} - –∞–∫—Ç–∏–≤–Ω–∞)</p>
    <p><strong>–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ã:</strong> {{ shift.controllers|join(', ') }}</p>
</div>

{% if shift.statistics %}
<div class="statistics-section">
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–º–µ–Ω—ã</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <h4>üìù –ó–∞–ø–∏—Å–µ–π</h4>
            <p style="font-size: 24px; font-weight: bold; color: #007bff;">{{ shift.statistics.total_records }}</p>
        </div>
        <div class="stat-card">
            <h4>üè≠ –û—Ç–ª–∏—Ç–æ</h4>
            <p style="font-size: 24px; font-weight: bold; color: #28a745;">{{ shift.statistics.total_cast }}</p>
        </div>
        <div class="stat-card">
            <h4>‚úÖ –ü—Ä–∏–Ω—è—Ç–æ</h4>
            <p style="font-size: 24px; font-weight: bold; color: #17a2b8;">{{ shift.statistics.total_accepted }}</p>
        </div>
        <div class="stat-card">
            <h4>üìà –ö–∞—á–µ—Å—Ç–≤–æ</h4>
            <p style="font-size: 24px; font-weight: bold; color: #ffc107;">{{ shift.statistics.avg_quality }}%</p>
        </div>
    </div>
    
    {% if shift.statistics.defects %}
    <h4 style="margin-top: 20px;">üîß –¢–æ–ø-3 –¥–µ—Ñ–µ–∫—Ç–∞:</h4>
    {% for defect in shift.statistics.defects[:3] %}
    <p>‚Ä¢ {{ defect.category }}: {{ defect.name }} ({{ defect.count }})</p>
    {% endfor %}
    {% endif %}
</div>
{% endif %}

<div class="search-section">
    <h3>üîç –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="cardNumber" placeholder="000295" maxlength="6" style="flex: 1;">
        <button class="btn" onclick="searchCard()">üîç –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç—É</button>
        <button class="btn btn-info" onclick="startQRScan()">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    </div>
    <div id="qrReader" style="display: none; margin: 10px 0;"></div>
    <div id="cardResult"></div>
</div>

<a href="/reports" class="btn btn-info">üìä –û—Ç—á–µ—Ç—ã</a>
<a href="/manage-controllers" class="btn btn-secondary">üë• –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ã</a>
<button class="btn btn-danger" onclick="closeShift()">üîö –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
let html5QrcodeScanner = null;

async function searchCard() {
    const cardNumber = document.getElementById('cardNumber').value;
    if (!cardNumber) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã');
        return;
    }
    
    try {
        const response = await fetch(`/api/search-card/${cardNumber}`);
        const data = await response.json();
        
        const resultDiv = document.getElementById('cardResult');
        if (data.success) {
            const card = data.card;
            resultDiv.innerHTML = `
                <div class="card-info">
                    <h4>‚úÖ –ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞</h4>
                    <p><strong>–ù–æ–º–µ—Ä:</strong> ${card.–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è_–∫–∞—Ä—Ç–∞}</p>
                    <p><strong>–£—á–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä:</strong> ${card.–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–ù–æ–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞:</strong> ${card.–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞ || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–∏–≤–∫–∏:</strong> ${card.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏ || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p><strong>–¢–∏–ø –ª–∏—Ç–Ω–∏–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:</strong> ${card.–¢–∏–ø_–ª–∏—Ç–Ω–∏–∫–æ–≤–æ–π_—Å–∏—Å—Ç–µ–º—ã || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <button class="btn" onclick="proceedToInput('${cardNumber}')">‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤–≤–æ–¥—É –∫–æ–Ω—Ç—Ä–æ–ª—è</button>
                </div>
            `;
        } else {
            if (data.already_processed) {
                resultDiv.innerHTML = '<div class="flash-warning">‚ö†Ô∏è ' + data.error + '</div>';
            } else {
                resultDiv.innerHTML = '<div class="flash-error">‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
            }
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
    }
}

function startQRScan() {
    const qrReaderDiv = document.getElementById('qrReader');
    
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
        qrReaderDiv.style.display = 'none';
        return;
    }
    
    qrReaderDiv.style.display = 'block';
    qrReaderDiv.innerHTML = '<div id="qr-reader" style="width: 100%;"></div><button onclick="stopQRScan()" class="btn btn-danger" style="margin-top: 10px;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>';
    
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };
    
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        config,
        (decodedText, decodedResult) => {
            document.getElementById('cardNumber').value = decodedText;
            stopQRScan();
            searchCard();
        },
        (errorMessage) => {}
    ).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        qrReaderDiv.style.display = 'none';
    });
}

function stopQRScan() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
            document.getElementById('qrReader').style.display = 'none';
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:', err);
        });
    }
}

// Auto-update statistics every 30 seconds
async function updateStatistics() {
    try {
        const response = await fetch('/api/shifts/current');
        const data = await response.json();
        if (data.success && data.shift.statistics) {
            const stats = data.shift.statistics;
            const statCards = document.querySelectorAll('.stat-card p');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.total_records || 0;
                statCards[1].textContent = stats.total_cast || 0;
                statCards[2].textContent = stats.total_accepted || 0;
                statCards[3].textContent = (stats.avg_quality || 0) + '%';
            }
        }
    } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

setInterval(updateStatistics, 30000);
</script>
{% endblock %}
