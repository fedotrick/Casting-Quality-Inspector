{% extends "base.html" %}

{% block title %}–í–≤–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞{% endblock %}

{% block content %}
<h1>üìù –í–≤–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞</h1>

<div class="card-info">
    <h3>–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞: {{ card_number }}</h3>
    <p><strong>–£—á–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä:</strong> {{ foundry_data.–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
    <p><strong>–ù–æ–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞:</strong> {{ foundry_data.–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞ or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
    <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–∏–≤–∫–∏:</strong> {{ foundry_data.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏ or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
    <p><strong>–¢–∏–ø –ª–∏—Ç–Ω–∏–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:</strong> {{ foundry_data.–¢–∏–ø_–ª–∏—Ç–Ω–∏–∫–æ–≤–æ–π_—Å–∏—Å—Ç–µ–º—ã or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
</div>

<form method="POST" action="{{ url_for('ui.save_control') }}">
    <input type="hidden" name="card_number" value="{{ card_number }}">
    
    <div style="margin-bottom: 20px;">
        <label for="total_cast">–í—Å–µ–≥–æ –æ—Ç–ª–∏—Ç–æ:</label>
        <input type="number" id="total_cast" name="total_cast" required min="1" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 20px;">
        <label for="total_accepted">–í—Å–µ–≥–æ –ø—Ä–∏–Ω—è—Ç–æ:</label>
        <input type="number" id="total_accepted" name="total_accepted" required min="0" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 20px;">
        <label for="controller">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä:</label>
        <select id="controller" name="controller" required style="width: 100%;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞</option>
            {% for controller_name in shift.controllers %}
            <option value="{{ controller_name }}">{{ controller_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <h3>–î–µ—Ñ–µ–∫—Ç—ã:</h3>
    {% for category in defect_types %}
    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px;">
        <h4>{{ category.name }}</h4>
        {% for defect_type in category.types %}
        <div style="margin: 5px 0; display: flex; align-items: center; gap: 10px;">
            <label for="defect_{{ defect_type.id }}" style="flex: 1; font-weight: normal;">{{ defect_type.name }}:</label>
            <input type="number" id="defect_{{ defect_type.id }}" name="defect_{{ defect_type.id }}" min="0" value="0" style="width: 100px;">
        </div>
        {% endfor %}
    </div>
    {% endfor %}
    
    <div style="margin-bottom: 20px;">
        <label for="notes">–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <textarea id="notes" name="notes" rows="3" style="width: 100%;"></textarea>
    </div>
    
    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <a href="{{ url_for('ui.work_menu') }}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Auto-calculate accepted based on defects
document.addEventListener('DOMContentLoaded', function() {
    const totalCastInput = document.getElementById('total_cast');
    const totalAcceptedInput = document.getElementById('total_accepted');
    const defectInputs = document.querySelectorAll('input[name^="defect_"]');
    
    function calculateAccepted() {
        const totalCast = parseInt(totalCastInput.value) || 0;
        let totalDefects = 0;
        
        defectInputs.forEach(input => {
            totalDefects += parseInt(input.value) || 0;
        });
        
        const accepted = Math.max(0, totalCast - totalDefects);
        totalAcceptedInput.value = accepted;
    }
    
    totalCastInput.addEventListener('input', calculateAccepted);
    defectInputs.forEach(input => {
        input.addEventListener('input', calculateAccepted);
    });
});
</script>
{% endblock %}
