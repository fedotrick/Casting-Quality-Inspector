# 🗺️ User Flows - Пользовательские сценарии

> **Описание всех основных user flows системы контроля качества**

---

## 📋 Содержание

1. [Начало рабочей смены](#1-начало-рабочей-смены)
2. [Проверка детали](#2-проверка-детали)
3. [Завершение смены](#3-завершение-смены)
4. [Работа с контролёрами](#4-работа-с-контролёрами)
5. [Просмотр отчётов](#5-просмотр-отчётов)
6. [QR-сканирование](#6-qr-сканирование)

---

## 1. 🚀 Начало рабочей смены

### Диаграмма потока

```
┌─────────────┐
│  Открытие   │
│  приложения │
└──────┬──────┘
       │
       ▼
┌─────────────────┐        ┌──────────────┐
│  Есть активная  │──Да──▶ │  Рабочее     │
│     смена?      │        │  меню        │
└────────┬────────┘        └──────────────┘
         │
        Нет
         │
         ▼
┌─────────────────┐
│  Welcome screen │
│  с анимацией    │
└────────┬────────┘
         │
         ▼ (Нажатие "Начать работу")
┌─────────────────┐
│  Форма создания │
│     смены       │
└────────┬────────┘
         │
         ▼ (Заполнение формы)
┌─────────────────┐
│  1. Дата        │
│  2. Номер смены │
│  3. Контролёры  │
└────────┬────────┘
         │
         ▼ (Валидация)
┌─────────────────┐        ┌──────────────┐
│  Данные         │──Нет──▶│  Показ       │
│  корректны?     │        │  ошибок      │
└────────┬────────┘        └──────┬───────┘
         │                        │
        Да                        │
         │                        │
         ▼                        │
┌─────────────────┐               │
│  Создание смены │               │
│  в БД           │               │
└────────┬────────┘               │
         │                        │
         ▼                        │
┌─────────────────┐               │
│  Сохранение     │               │
│  ID в session   │               │
└────────┬────────┘               │
         │                        │
         ▼                        │
┌─────────────────┐               │
│  Редирект на    │◀──────────────┘
│  рабочее меню   │    (После исправления)
└─────────────────┘
```

---

### Описание шагов

#### Шаг 1: Открытие приложения
- **URL**: `/`
- **Проверка**: Есть ли активная смена в session?
- **Если да**: Редирект на `/work-menu`
- **Если нет**: Показать welcome screen

#### Шаг 2: Welcome Screen
- **Отображение**:
  - Анимированный лого (плавающая иконка 🏭)
  - Заголовок "Система контроля качества"
  - Подзаголовок "Литейное производство"
  - Анимированный фон с частицами
- **Действие**: Кнопка "🚀 Начать работу"
- **Переход**: `/create-shift`

#### Шаг 3: Форма создания смены
- **Поля формы**:
  1. **Дата смены** (date input)
     - Автозаполнение: текущая дата
     - Валидация: не в будущем (с запасом +1 день)
  
  2. **Номер смены** (select)
     - Вариант 1: "Смена 1 (07:00 - 19:00)"
     - Вариант 2: "Смена 2 (19:00 - 07:00)"
     - Автовыбор: на основе текущего времени
  
  3. **Контролёры** (checkboxes)
     - Список всех активных контролёров из БД
     - Множественный выбор
     - Валидация: минимум 1 контролёр

- **Кнопки**:
  - "✅ Создать смену" (submit)
  - "❌ Отмена" (возврат на главную)

#### Шаг 4: Валидация
**Проверки**:
- ✅ Дата заполнена и в корректном формате
- ✅ Дата не в будущем
- ✅ Номер смены = 1 или 2
- ✅ Выбран хотя бы один контролёр
- ✅ Нет дублирующей активной смены на эту дату

**Если ошибки**:
- Flash-сообщения (красные) с описанием проблем
- Форма остается заполненной
- Пользователь исправляет и отправляет снова

#### Шаг 5: Создание смены
**Backend операции**:
1. Создание записи в таблице `Смены`
2. Сохранение списка контролёров (JSON)
3. Установка статуса "активна"
4. Фиксация времени начала
5. Сохранение `shift_id` в session

**Результат**:
- Flash-сообщение: "Смена успешно создана!" (зеленое)
- Редирект на `/work-menu`
- Логирование в application.log

---

### Альтернативные пути

#### Альтернатива 1: Активная смена уже существует
```
/create-shift ──▶ Проверка активной смены
                          │
                          ▼
                  Flash: "Смена уже активна"
                          │
                          ▼
                  Редирект на /work-menu
```

#### Альтернатива 2: Нет контролёров в системе
```
/create-shift ──▶ Загрузка контролёров
                          │
                          ▼
                  Список пуст?
                          │
                          ▼
                  Сообщение: "Нет доступных контролёров"
                          │
                          ▼
                  Ссылка: "Добавить контролера"
                          │
                          ▼
                  /manage-controllers
```

---

### Обработка ошибок

**Ошибка БД при создании**:
```python
try:
    shift_id = create_shift(date, shift_number, controllers)
except Exception as e:
    flash(f'Ошибка при создании смены: {str(e)}', 'error')
    return redirect(url_for('ui.create_shift_route'))
```

**Ошибка дублирования**:
```python
if repo.check_duplicate(date, shift_number, statuses=('активна',)):
    flash('Смена уже активна на эту дату', 'error')
```

---

## 2. 🔍 Проверка детали

### Диаграмма потока

```
┌─────────────────┐
│  Рабочее меню   │
│  (Work Menu)    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│  Секция поиска маршрутной карты │
└────────┬────────────────────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────┐   ┌──────┐
│Ввод │   │ QR   │
│вручную│ │скан  │
└──┬──┘   └───┬──┘
    │         │
    └────┬────┘
         │
         ▼
┌─────────────────┐
│  Поиск карты в  │
│  Foundry DB     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   Да        Нет
    │         │
    ▼         ▼
┌────────┐  ┌──────────┐
│Найдена │  │Не найдена│
└───┬────┘  └──────────┘
    │           │
    ▼           ▼
┌────────────┐  Flash: "Карта не найдена"
│Проверка    │
│дубликата   │
└─────┬──────┘
      │
  ┌───┴───┐
  │       │
 Да      Нет
  │       │
  ▼       ▼
Flash:  ┌──────────────┐
"Уже    │Отображение   │
обработ"│информации    │
        │о карте       │
        └──────┬───────┘
               │
               ▼ (Кнопка "Перейти к вводу")
        ┌──────────────┐
        │Форма ввода   │
        │контроля      │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │Заполнение:   │
        │1. Всего отлито│
        │2. Принято    │
        │3. Контролёр  │
        │4. Дефекты    │
        │5. Заметки    │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │Auto-calculate│
        │принято по    │
        │дефектам      │
        └──────┬───────┘
               │
               ▼ (Сохранить)
        ┌──────────────┐
        │Валидация     │
        │данных        │
        └──────┬───────┘
               │
          ┌────┴────┐
          │         │
         Да        Нет
          │         │
          ▼         ▼
   ┌──────────┐  Flash: Ошибки
   │Сохранение│
   │в БД      │
   └─────┬────┘
         │
         ▼
   ┌──────────────┐
   │Обновление    │
   │статуса в     │
   │External DB   │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │Flash: Успех  │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │Редирект на   │
   │work-menu     │
   └──────────────┘
```

---

### Описание шагов

#### Шаг 1: Поиск маршрутной карты

**Вариант A: Ручной ввод**
1. Пользователь вводит 6-значный номер в поле
2. Нажимает "🔍 Найти карту"
3. JavaScript вызывает `searchCard()`
4. Отправка GET запроса: `/api/search-card/{cardNumber}`

**Вариант B: QR-сканирование**
1. Нажатие "📱 Сканировать QR"
2. Запрос доступа к камере браузера
3. Отображение видео с рамкой сканирования
4. При обнаружении QR:
   - Номер вставляется в поле ввода
   - Сканер автоматически закрывается
   - Вызывается `searchCard()` автоматически

#### Шаг 2: Валидация номера карты

**Backend проверки**:
```python
# Формат номера
if not re.match(r'^\d{6}$', card_number):
    return jsonify({'success': False, 'error': 'Неверный формат'})

# Проверка дубликата
if check_card_already_processed(card_number):
    return jsonify({
        'success': False, 
        'error': 'Карта уже обработана',
        'already_processed': True
    })
```

#### Шаг 3: Поиск в Foundry DB

**SQL запрос**:
```python
foundry_data = search_route_card_in_foundry(card_number)
# Ищет в таблице Литейка.ТаблицаЛитейка
```

**Если найдена**:
```javascript
resultDiv.innerHTML = `
    <div class="card-info">
        <h4>✅ Маршрутная карта найдена</h4>
        <p><strong>Номер:</strong> ${card.Маршрутная_карта}</p>
        <p><strong>Учетный номер:</strong> ${card.Учетный_номер}</p>
        <p><strong>Наименование отливки:</strong> ${card.Наименование_отливки}</p>
        <button onclick="proceedToInput('${cardNumber}')">
            ➡️ Перейти к вводу контроля
        </button>
    </div>
`;
```

**Если не найдена**:
```javascript
resultDiv.innerHTML = '<div class="flash-error">❌ Карта не найдена</div>';
```

#### Шаг 4: Форма ввода контроля качества

**URL**: `/input-control?card=000295`

**Отображаемая информация**:
- Номер маршрутной карты
- Учетный номер
- Номер кластера
- Наименование отливки
- Тип литниковой системы

**Поля формы**:

1. **Всего отлито** (number, required, min=1)
   ```html
   <input type="number" name="total_cast" required min="1">
   ```

2. **Всего принято** (number, required, min=0)
   ```html
   <input type="number" name="total_accepted" required min="0">
   ```
   - Auto-calculated на основе дефектов

3. **Контролёр** (select, required)
   - Список контролёров текущей смены

4. **Дефекты** (числовые поля по категориям)
   - Организованы по категориям
   - Минимум: 0
   - По умолчанию: 0

5. **Заметки** (textarea, optional)
   - 3 строки
   - Необязательное поле

#### Шаг 5: Auto-calculate функция

**JavaScript логика**:
```javascript
function calculateAccepted() {
    const totalCast = parseInt(totalCastInput.value) || 0;
    let totalDefects = 0;
    
    defectInputs.forEach(input => {
        totalDefects += parseInt(input.value) || 0;
    });
    
    const accepted = Math.max(0, totalCast - totalDefects);
    totalAcceptedInput.value = accepted;
}

// Триггеры
totalCastInput.addEventListener('input', calculateAccepted);
defectInputs.forEach(input => {
    input.addEventListener('input', calculateAccepted);
});
```

**Логика**:
- Принято = Отлито - Сумма всех дефектов
- Минимум: 0 (не может быть отрицательным)
- Обновляется в real-time при вводе

#### Шаг 6: Сохранение данных

**POST запрос**: `/save-control`

**Backend обработка**:
1. Валидация всех полей
2. Создание записи контроля в БД
3. Запись дефектов (отдельная таблица)
4. Обновление статуса в External DB
5. Логирование операции

**Успех**:
```python
flash('Данные контроля сохранены успешно!', 'success')
return redirect(url_for('ui.work_menu'))
```

**Ошибка**:
```python
flash(f'Ошибка: {str(e)}', 'error')
return redirect(url_for('ui.input_control'))
```

---

### Альтернативные пути

#### Альтернатива 1: Карта уже обработана
```
Поиск карты
    │
    ▼
Найдена, но уже есть в текущей смене
    │
    ▼
Flash-warning: "Маршрутная карта 000295 уже обработана"
    │
    ▼
Остаться на work-menu (можно искать другую)
```

#### Альтернатива 2: Ошибка камеры при QR-сканировании
```
Нажатие "Сканировать QR"
    │
    ▼
Запрос доступа к камере
    │
    ▼
Пользователь отклонил / Камера недоступна
    │
    ▼
Alert: "Не удалось запустить камеру. Проверьте разрешения."
    │
    ▼
Скрыть QR-reader div
    │
    ▼
Использовать ручной ввод
```

---

### Обработка ошибок

**Ошибка 1: Некорректный формат номера**
- Валидация: только 6 цифр
- Ответ: HTTP 400, JSON с ошибкой
- UI: Flash-error

**Ошибка 2: Валидация формы ввода**
```python
errors = validate_control_data(total_cast, total_accepted, controller, defects)
if errors:
    for error in errors:
        flash(error, 'error')
    return redirect(...)
```

**Ошибка 3: Проблема с External DB**
- Try-catch при обновлении статуса
- Логирование ошибки
- Продолжение работы (не блокирует сохранение)

---

## 3. 🔚 Завершение смены

### Диаграмма потока

```
┌─────────────────┐
│  Рабочее меню   │
└────────┬────────┘
         │
         ▼ (Нажатие "Закрыть смену")
┌─────────────────┐
│  Подтверждение  │
│  (confirm)      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   Да        Нет
    │         │
    │         ▼
    │    Отмена (остаться на странице)
    │
    ▼
┌─────────────────┐
│  API запрос:    │
│  /api/close-shift│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Backend:       │
│  1. Проверка    │
│     активной    │
│     смены       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
  Есть       Нет
    │         │
    │         ▼
    │    Error: "Нет активной смены"
    │
    ▼
┌─────────────────┐
│  Обновление БД: │
│  - Статус →     │
│    "завершена"  │
│  - end_time     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Очистка session│
│  (удалить       │
│  shift_id)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  JSON Response: │
│  {success: true}│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Alert:         │
│  "Смена успешно │
│   закрыта"      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Редирект на    │
│  главную (/)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Welcome screen │
│  (новый цикл)   │
└─────────────────┘
```

---

### Описание шагов

#### Шаг 1: Инициация закрытия
**UI**: Кнопка на work-menu
```html
<button class="btn btn-danger" onclick="closeShift()">🔚 Закрыть смену</button>
```

**JavaScript подтверждение**:
```javascript
if (!confirm('Вы уверены, что хотите закрыть смену?')) {
    return;  // Отмена
}
```

#### Шаг 2: API запрос

**JavaScript**:
```javascript
const response = await fetch('/api/close-shift', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    }
});
```

#### Шаг 3: Backend обработка

```python
@api_bp.route('/close-shift', methods=['POST'])
def api_close_shift():
    # 1. Получить текущую смену из session
    current_shift = get_current_shift()
    
    if not current_shift:
        return jsonify({'success': False, 'error': 'Нет активной смены'}), 400
    
    # 2. Закрыть смену в БД
    close_shift(current_shift['id'])
    
    # 3. Очистить session
    session.pop('current_shift_id', None)
    
    # 4. Логирование
    logger.info(f"Shift {current_shift['id']} closed")
    
    return jsonify({'success': True, 'message': 'Смена закрыта успешно'})
```

**Операции БД**:
```python
def close_shift(shift_id):
    # UPDATE Смены 
    # SET статус = 'завершена', 
    #     время_окончания = NOW()
    # WHERE id = shift_id
```

#### Шаг 4: UI обратная связь

**Успех**:
```javascript
if (data.success) {
    alert('Смена успешно закрыта');
    window.location.href = '/';  // Редирект на главную
}
```

**Ошибка**:
```javascript
else {
    alert('Ошибка при закрытии смены: ' + data.error);
}
```

---

### Альтернативные пути

#### Альтернатива 1: Автоматическое закрытие устаревших смен

**Триггер**: При запуске приложения / периодически

```python
def auto_close_expired_shifts():
    # Найти смены старше 24 часов со статусом "активна"
    # Автоматически закрыть их
```

**Логика**:
- Если смена активна более 24 часов → автоматически завершена
- Логирование события

#### Альтернатива 2: Закрытие с предварительным просмотром статистики

**Расширенный флоу**:
```
Кнопка "Закрыть смену"
    │
    ▼
Модальное окно с финальной статистикой
    │
    ├─ Всего записей: X
    ├─ Всего отлито: Y
    ├─ Всего принято: Z
    ├─ Средний % качества: W
    │
    ▼
Подтверждение "Завершить смену"
    │
    ▼
Закрытие...
```

*Примечание: В текущей версии не реализовано, но запланировано*

---

## 4. 👥 Работа с контролёрами

### Диаграмма потока

```
┌─────────────────┐
│  Work Menu /    │
│  Welcome        │
└────────┬────────┘
         │
         ▼ (Кнопка "Контролёры")
┌─────────────────┐
│  /manage-       │
│  controllers    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  Секция "Добавить контролёр"│
│  + Таблица контролёров      │
└──────────┬──────────────────┘
           │
    ┌──────┴──────┬───────────┬──────────┐
    │             │           │          │
    ▼             ▼           ▼          ▼
┌────────┐   ┌─────────┐  ┌──────┐  ┌──────┐
│Добавить│   │Активи-  │  │Деакти│  │Удалить│
│        │   │ровать   │  │вир.  │  │      │
└───┬────┘   └────┬────┘  └───┬──┘  └───┬──┘
    │             │            │         │
    │             │            │         │
    ▼             ▼            ▼         ▼
  [Flows описаны ниже]
```

---

### Flow 1: Добавление контролёра

```
Форма "Добавить контролёра"
    │
    ▼ (Ввод имени)
┌─────────────────┐
│  Input:         │
│  "Иванов И.И."  │
└────────┬────────┘
         │
         ▼ (Кнопка "Добавить")
┌─────────────────┐
│  Валидация:     │
│  - Не пустое    │
│  - Минимум 3    │
│    символа      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   Ок      Ошибка
    │         │
    │         ▼
    │    Alert: "Введите имя"
    │
    ▼
┌─────────────────┐
│  POST:          │
│  /api/add-      │
│  controller     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  INSERT в БД:   │
│  Контролёры     │
│  (имя, активен) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Обновление     │
│  страницы       │
│  (reload)       │
└─────────────────┘
```

**JavaScript**:
```javascript
async function addController(event) {
    event.preventDefault();
    const name = document.getElementById('controllerName').value;
    
    const formData = new FormData();
    formData.append('name', name);
    
    const response = await fetch('/api/add-controller', {
        method: 'POST',
        body: formData
    });
    
    if (data.success) {
        alert('Контролер добавлен');
        location.reload();
    }
}
```

---

### Flow 2: Активация/Деактивация контролёра

```
Таблица контролёров
    │
    ▼ (Кнопка "Деактивировать" / "Активировать")
┌─────────────────┐
│  POST:          │
│  /api/toggle-   │
│  controller     │
│  {id: X}        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  UPDATE БД:     │
│  активен =      │
│  NOT активен    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Обновление     │
│  страницы       │
└─────────────────┘
```

**Особенность**: Кнопка меняет текст в зависимости от статуса
```html
{{ 'Деактивировать' if controller.активен else 'Активировать' }}
```

---

### Flow 3: Удаление контролёра

```
Таблица контролёров
    │
    ▼ (Кнопка "Удалить")
┌─────────────────┐
│  Confirm:       │
│  "Вы уверены?"  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   Да        Нет
    │         │
    │         ▼
    │    Отмена
    │
    ▼
┌─────────────────┐
│  POST:          │
│  /api/delete-   │
│  controller     │
│  {id: X}        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  DELETE из БД   │
│  WHERE id = X   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Обновление     │
│  страницы       │
└─────────────────┘
```

**JavaScript confirm**:
```javascript
if (!confirm('Вы уверены, что хотите удалить этого контролера?')) {
    return;
}
```

---

### Отображение таблицы

**Структура**:
```html
<table>
    <thead>
        <tr>
            <th>Имя</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Иванов И.И.</td>
            <td>Активен</td>
            <td>
                <button class="btn btn-warning">Деактивировать</button>
                <button class="btn btn-danger">Удалить</button>
            </td>
        </tr>
    </tbody>
</table>
```

**Empty state**:
```html
{% else %}
<p>Нет контролеров</p>
{% endif %}
```

---

## 5. 📊 Просмотр отчётов

### Диаграмма потока

```
┌─────────────────┐
│  Work Menu      │
└────────┬────────┘
         │
         ▼ (Кнопка "Отчеты")
┌─────────────────┐
│  /reports       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Загрузка всех  │
│  смен из БД     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Отображение    │
│  таблицы смен   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
  Есть      Нет
  смены     смен
    │         │
    │         ▼
    │    "Нет данных о сменах"
    │
    ▼
┌─────────────────────┐
│  Таблица:           │
│  - Дата             │
│  - Номер смены      │
│  - Контролёры       │
│  - Время (начало -  │
│    конец / активна) │
│  - Статус           │
└─────────────────────┘
         │
         ▼
┌─────────────────┐
│  Кнопка "Назад" │
│  → Work Menu    │
└─────────────────┘
```

---

### Описание

**URL**: `/reports`

**Backend**:
```python
@ui_bp.route('/reports')
def reports():
    shifts = get_all_shifts()  # ORDER BY дата DESC, смена DESC
    return render_template('reports.html', shifts=shifts)
```

**Отображаемые данные**:
- ✅ Дата смены
- ✅ Номер смены (1 или 2)
- ✅ Список контролёров (через запятую)
- ✅ Время: "07:30 - 19:15" или "07:30 - активна"
- ✅ Статус: "активна" / "завершена" / "закрыта"

**Сортировка**: По дате (новые сверху)

---

### Планируемые расширения

**Версия 2.0**:
- Фильтрация по датам
- Поиск по контролёру
- Детальная статистика по клику на смену
- Экспорт в Excel
- Графики качества

---

## 6. 📱 QR-сканирование

### Диаграмма потока

```
┌─────────────────┐
│  Work Menu      │
│  (Поиск карты)  │
└────────┬────────┘
         │
         ▼ (Кнопка "Сканировать QR")
┌─────────────────┐
│  startQRScan()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Запрос доступа │
│  к камере       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
Разрешено  Отклонено
    │         │
    │         ▼
    │    Alert: "Проверьте разрешения"
    │         │
    │         ▼
    │    Скрыть QR-reader
    │
    ▼
┌─────────────────┐
│  Инициализация  │
│  Html5Qrcode    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Отображение    │
│  видео с камеры │
│  + рамка        │
│  сканирования   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Непрерывное    │
│  сканирование   │
│  (10 fps)       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
QR найден  Не найден
    │         │
    │         ▼
    │    Продолжить сканирование
    │
    ▼
┌─────────────────┐
│  Decoded text:  │
│  "000295"       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Вставить в     │
│  поле ввода     │
│  cardNumber     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Остановить и   │
│  закрыть сканер │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Автоматический │
│  вызов          │
│  searchCard()   │
└────────┬────────┘
         │
         ▼
    [Flow "Проверка детали", шаг 2]
```

---

### Технические детали

**Библиотека**: html5-qrcode
```html
<script src="https://unpkg.com/html5-qrcode"></script>
```

**Конфигурация**:
```javascript
const config = {
    fps: 10,                      // 10 кадров в секунду
    qrbox: { width: 250, height: 250 }  // Размер рамки
};

const cameraConfig = {
    facingMode: "environment"     // Задняя камера
};
```

**Callbacks**:
```javascript
// Успешное декодирование
(decodedText, decodedResult) => {
    document.getElementById('cardNumber').value = decodedText;
    stopQRScan();
    searchCard();
}

// Ошибка декодирования (игнорируется)
(errorMessage) => {
    // Не показывается пользователю
}
```

---

### UX особенности

**1. Toggle функция**:
- Повторное нажатие "Сканировать QR" → остановка сканера
- Кнопка работает как переключатель

**2. Автоматический поиск**:
- После успешного сканирования сразу выполняется поиск
- Пользователю не нужно нажимать "Найти карту"

**3. Обработка ошибок**:
- Если камера недоступна → alert с объяснением
- QR-reader скрывается
- Пользователь может использовать ручной ввод

**4. Mobile-friendly**:
- На мобильных устройствах использует основную камеру
- На desktop может использовать веб-камеру

---

### Альтернативные пути

**Альтернатива 1: Некорректный QR-код**
```
QR отсканирован
    │
    ▼
Decoded text: "ABC123" (не 6 цифр)
    │
    ▼
Вставлен в поле ввода
    │
    ▼
Автоматический поиск searchCard()
    │
    ▼
API валидация: "Неверный формат номера"
    │
    ▼
Flash-error отображается
    │
    ▼
Пользователь может повторить или ввести вручную
```

**Альтернатива 2: QR-код другой системы**
```
QR отсканирован: "987654"
    │
    ▼
Поиск в Foundry DB
    │
    ▼
Не найдена
    │
    ▼
Flash-error: "Карта не найдена"
```

---

## 🎯 Общие принципы UX

### 1. Последовательность действий
Все flows следуют логическому порядку:
1. Вход → 2. Действие → 3. Подтверждение → 4. Результат

### 2. Обратная связь
- ✅ Flash-сообщения для всех важных действий
- ⚠️ Confirm для деструктивных операций
- 🔄 Loading indicators (где необходимо)

### 3. Обработка ошибок
- Все ошибки логируются
- Пользователю показывается понятное сообщение
- Возможность повторить действие

### 4. Навигация
- Всегда есть кнопка "Назад"
- Логические переходы между страницами
- Редиректы после успешных действий

### 5. Валидация
- Frontend: базовая проверка (required, pattern)
- Backend: полная валидация бизнес-логики
- Real-time feedback где возможно

---

*User flows документация обновлена: 2024*
